<div id="a11y-widget" role="region" aria-label="Outils d'accessibilité">
    <div class="a11y-controls">
        <button id="btn-play" aria-label="Lire le contenu de la page" title="Lire la page">
            ▶ Lire la page
        </button>
        <button id="btn-pause" aria-label="Mettre en pause la lecture" title="Pause" style="display:none;">
            ⏸ Pause
        </button>
        <button id="btn-stop" aria-label="Arrêter la lecture" title="Arrêter">
            ⏹ Arrêter
        </button>
    </div>
    <div id="a11y-status" aria-live="polite">Prêt à lire</div>
</div>

<style>
    /* --- STYLE DU WIDGET --- */
    #a11y-widget {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #111827; /* Fond sombre */
        border: 4px solid #FFD700; /* Jaune très contrasté */
        border-radius: 12px;
        padding: 15px;
        z-index: 99999; /* Au-dessus de tout le reste */
        font-family: 'Verdana', sans-serif;
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        max-width: 300px;
    }

    .a11y-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
    }

    #a11y-widget button {
        background-color: #FFD700;
        color: #000000;
        border: 2px solid #FFFFFF;
        padding: 10px 15px;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        border-radius: 6px;
        flex: 1;
        transition: transform 0.1s, background 0.2s;
    }

    #a11y-widget button:hover, #a11y-widget button:focus {
        background-color: #FFFFFF;
        border-color: #FFD700;
        transform: scale(1.05);
        outline: 2px solid #FFD700;
    }

    #a11y-status {
        color: #FFD700;
        text-align: center;
        font-weight: bold;
        font-size: 0.9rem;
    }
</style>

<script>
    (function() {
        // --- LOGIQUE DE SYNTHÈSE VOCALE ---
        const synth = window.speechSynthesis;
        let utterance = null;
        
        const btnPlay = document.getElementById('btn-play');
        const btnPause = document.getElementById('btn-pause');
        const btnStop = document.getElementById('btn-stop');
        const statusDisplay = document.getElementById('a11y-status');

        // Fonction pour récupérer le texte pertinent (évite les menus et footers techniques)
        function getReadableContent() {
            // On cible les titres et paragraphes principaux
            // Note: Sur Google Sites, le contenu est souvent dans des div spécifiques, 
            // ici on ratisse large mais proprement.
            const contentNodes = document.querySelectorAll('h1, h2, h3, p, article, .tyJCtd'); 
            let textToRead = "";
            
            contentNodes.forEach(node => {
                // On évite le texte caché ou vide
                if(node.innerText && node.innerText.trim().length > 0 && node.offsetParent !== null) {
                    textToRead += node.innerText + ". ";
                }
            });
            return textToRead;
        }

        function startReading() {
            if (synth.speaking && synth.paused) {
                synth.resume();
                togglePlayPause(true);
                statusDisplay.textContent = "Lecture en cours...";
                return;
            }

            // Annuler toute lecture précédente
            synth.cancel();

            const text = getReadableContent();
            if (!text) {
                statusDisplay.textContent = "Aucun texte détecté.";
                return;
            }

            utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'fr-FR'; // Force la langue française
            utterance.rate = 1; // Vitesse normale
            utterance.pitch = 1;

            // Événements de lecture
            utterance.onend = () => {
                togglePlayPause(false);
                statusDisplay.textContent = "Lecture terminée.";
            };

            utterance.onerror = () => {
                togglePlayPause(false);
                statusDisplay.textContent = "Erreur de lecture.";
            };

            synth.speak(utterance);
            togglePlayPause(true);
            statusDisplay.textContent = "Lecture en cours...";
        }

        function pauseReading() {
            if (synth.speaking) {
                synth.pause();
                togglePlayPause(false);
                statusDisplay.textContent = "Lecture en pause.";
            }
        }

        function stopReading() {
            synth.cancel();
            togglePlayPause(false);
            statusDisplay.textContent = "Lecture arrêtée.";
        }

        function togglePlayPause(isPlaying) {
            if (isPlaying) {
                btnPlay.style.display = 'none';
                btnPause.style.display = 'inline-block';
                btnPause.focus(); // Garde le focus pour l'accessibilité
            } else {
                btnPlay.style.display = 'inline-block';
                btnPause.style.display = 'none';
                if(document.activeElement === btnPause) btnPlay.focus();
            }
        }

        // Écouteurs d'événements
        btnPlay.addEventListener('click', startReading);
        btnPause.addEventListener('click', pauseReading);
        btnStop.addEventListener('click', stopReading);

        // Nettoyage si on quitte la page
        window.addEventListener('beforeunload', () => {
            synth.cancel();
        });

    })();
</script>
