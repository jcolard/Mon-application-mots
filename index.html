<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Organisateur de Tiroirs avec Supabase (Tout en un)</title>
    <!-- Inclut Tailwind CSS depuis un CDN pour un style rapide -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclut Babel Standalone pour la transpilation de JSX directement dans le navigateur -->
    <!-- ATTENTION: Non recommandé pour la production en raison des performances. Idéal pour les démos simples. -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Chargement des bibliothèques React et ReactDOM via UMD (Universal Module Definition) -->
    <!-- Ces versions exposent React et ReactDOM comme des variables globales. -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Chargement de la bibliothèque Supabase via UMD -->
    <!-- Cela expose la fonction `supabase` globalement pour `createClient`. -->
    <script src="https://unpkg.com/@supabase/supabase-js@2.44.0/dist/umd/supabase-js.min.js"></script>

    <style>
        /* Styles personnalisés pour cette application */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        #root {
            width: 100%;
            max-width: 1200px; /* Limite la largeur du contenu principal */
        }
        .word-cloud-container, .drop-zones-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            width: 100%;
        }
        .word-item {
            cursor: grab;
            padding: 0.75rem 1.25rem;
            background-color: #60a5fa;
            color: white;
            border-radius: 0.75rem;
            font-weight: 600;
            text-align: center;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            position: relative; /* Pour positionner la croix de suppression */
        }
        .word-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .drop-zone {
            flex: 1;
            min-width: 200px;
            min-height: 150px;
            border: 2px dashed #9ca3af;
            border-radius: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
            background-color: #e2e8f0;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            text-align: center;
        }
        .drop-zone.drag-over {
            background-color: #d1fae5;
            border-color: #34d399;
        }
        .delete-btn {
            position: absolute;
            top: -8px; /* Ajuster la position verticale */
            right: -8px; /* Ajuster la position horizontale */
            background-color: #ef4444; /* Rouge */
            color: white;
            border-radius: 9999px; /* Cercle parfait */
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.75rem; /* Petite taille de police */
            font-weight: bold;
            cursor: pointer;
            line-height: 1; /* Supprimer l'espacement de ligne pour centrer le 'x' */
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: background-color 0.2s;
        }
        .delete-btn:hover {
            background-color: #dc2626; /* Rouge plus foncé au survol */
        }
    </style>
</head>
<body class="bg-slate-50">
    <!-- Point de montage de l'application React -->
    <div id="root"></div>

    <!-- Script principal de l'application React, tout le code est ici -->
    <script type="text/babel">
        // Initialisation du client Supabase
        // Utilise window.supabase car la bibliothèque est chargée via UMD
        const supabaseUrl = 'https://aiddstzhjchcygpinifg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZGRzdHpoamNoY3lncGluaWZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NDA2OTQsImV4cCI6MjA3MDMxNjY5NH0.GIferB9cBMGehj3GkVVLbAHy0AHe-L9NY54pl7TGkPM';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Composant WordItem
        function WordItem({ word, onDelete, onDragStart }) {
            const handleDragStart = (e) => {
                e.dataTransfer.setData('text/plain', word.id);
                e.currentTarget.classList.add('opacity-50');
                onDragStart(word.id);
            };

            const handleDragEnd = (e) => {
                e.currentTarget.classList.remove('opacity-50');
            };

            return (
                <div
                    id={`word-${word.id}`}
                    className="word-item"
                    draggable="true"
                    onDragStart={handleDragStart}
                    onDragEnd={handleDragEnd}
                >
                    {word.Nom}
                    <span
                        className="delete-btn"
                        onClick={() => onDelete(word.id)}
                    >
                        &times;
                    </span>
                </div>
            );
        }

        // Composant Drawer
        function Drawer({ title, children, onDropWord }) {
            const [isDragOver, setIsDragOver] = React.useState(false);

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragOver(true);
            };

            const handleDragLeave = () => {
                setIsDragOver(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragOver(false);
                const wordId = e.dataTransfer.getData('text/plain');
                onDropWord(wordId, title);
            };

            return (
                <div
                    className={`drop-zone ${isDragOver ? 'drag-over' : ''}`}
                    onDragOver={handleDragOver}
                    onDragLeave={handleDragLeave}
                    onDrop={handleDrop}
                >
                    <h2 className="text-xl font-semibold text-gray-700 mb-2">{title}</h2>
                    {children}
                </div>
            );
        }

        // Composant App (principal)
        function App() {
            const [words, setWords] = React.useState([]);
            const [newWordText, setNewWordText] = React.useState('');
            const [draggedWordId, setDraggedWordId] = React.useState(null);

            const drawerStatuses = ["Tiroir 1", "Tiroir 2", "Tiroir 3", "Tiroir 4"];
            const centerStatus = "Centre";

            const fetchWords = async () => {
                try {
                    const { data, error } = await supabase
                        .from('Nuage de mot')
                        .select('*');

                    if (error) throw error;
                    // Supabase renvoie les IDs en tant que 'ID' (majuscule), nous le mappons en 'id' (minuscule) pour la cohérence React
                    setWords(data.map(word => ({ ...word, id: word.ID })) || []);
                } catch (error) {
                    console.error('Erreur lors de la récupération des mots:', error.message);
                }
            };

            React.useEffect(() => {
                fetchWords();
            }, []);

            const handleAddWord = async () => {
                if (!newWordText.trim()) return;

                const tempId = `temp-${Date.now()}`;
                const newWord = {
                    id: tempId,
                    Nom: newWordText.trim(),
                    Statut: centerStatus,
                    created_at: new Date().toISOString()
                };
                setWords(prevWords => [...prevWords, newWord]);
                setNewWordText('');

                try {
                    const { data, error } = await supabase
                        .from('Nuage de mot')
                        .insert([{ Nom: newWord.Nom, Statut: newWord.Statut }])
                        .select();

                    if (error) throw error;
                    setWords(prevWords =>
                        prevWords.map(word =>
                            word.id === tempId ? { ...data[0], id: data[0].ID } : word
                        )
                    );
                    console.log('Mot ajouté à Supabase:', data[0]);
                } catch (error) {
                    console.error('Erreur lors de l\'ajout du mot:', error.message);
                    setWords(prevWords => prevWords.filter(word => word.id !== tempId));
                }
            };

            const handleDropWord = async (wordId, newStatus) => {
                setWords(prevWords =>
                    prevWords.map(word =>
                        word.id === wordId ? { ...word, Statut: newStatus } : word
                    )
                );

                try {
                    const { error } = await supabase
                        .from('Nuage de mot')
                        .update({ Statut: newStatus })
                        .eq('ID', wordId); // Utiliser 'ID' car c'est le nom de la colonne dans Supabase

                    if (error) throw error;
                    console.log(`Mot ${wordId} déplacé vers ${newStatus} dans Supabase.`);
                } catch (error) {
                    console.error('Erreur lors de la mise à jour du statut:', error.message);
                    fetchWords();
                }
            };

            const handleDeleteWord = async (wordId) => {
                if (!window.confirm("Voulez-vous vraiment supprimer ce mot ?")) {
                    return;
                }

                setWords(prevWords => prevWords.filter(word => word.id !== wordId));

                try {
                    const { error } = await supabase
                        .from('Nuage de mot')
                        .delete()
                        .eq('ID', wordId); // Utiliser 'ID'

                    if (error) throw error;
                    console.log(`Mot ${wordId} supprimé de Supabase.`);
                } catch (error) {
                    console.error('Erreur lors de la suppression du mot:', error.message);
                    fetchWords();
                }
            };

            return (
                <div className="flex flex-col items-center p-4">
                    <h1 className="text-3xl font-bold text-gray-800 mb-8 mt-4">Glissez les mots dans les tiroirs !</h1>

                    <div className="bg-white p-4 rounded-lg shadow-md mb-8 flex gap-2 w-full max-w-md">
                        <input
                            type="text"
                            className="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Ajouter un nouveau mot..."
                            value={newWordText}
                            onChange={(e) => setNewWordText(e.target.value)}
                            onKeyPress={(e) => {
                                if (e.key === 'Enter') {
                                    handleAddWord();
                                }
                            }}
                        />
                        <button
                            className="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 transition-colors"
                            onClick={handleAddWord}
                        >
                            Ajouter
                        </button>
                    </div>

                    <h2 className="text-2xl font-semibold text-gray-800 mb-4">Mots non rangés</h2>
                    <div id="wordCloud" className="word-cloud-container">
                        {words
                            .filter(word => word.Statut === centerStatus)
                            .map(word => (
                                <WordItem
                                    key={word.id}
                                    word={word}
                                    onDelete={handleDeleteWord}
                                    onDragStart={setDraggedWordId}
                                />
                            ))}
                        {/* Zone de dépôt implicite pour le centre si besoin, ou simplement les mots */}
                    </div>

                    <h2 className="text-2xl font-semibold text-gray-800 mb-4 mt-8">Tiroirs</h2>
                    <div id="dropZones" className="drop-zones-container">
                        {drawerStatuses.map(status => (
                            <Drawer key={status} title={status} onDropWord={handleDropWord}>
                                {words
                                    .filter(word => word.Statut === status)
                                    .map(word => (
                                        <WordItem
                                            key={word.id}
                                            word={word}
                                            onDelete={handleDeleteWord}
                                            onDragStart={setDraggedWordId}
                                        />
                                    ))}
                            </Drawer>
                        ))}
                    </div>
                </div>
            );
        }

        // Rendu de l'application React
        // Utilise ReactDOM car il est exposé globalement par le script UMD
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
</body>
</html>
